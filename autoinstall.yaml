#cloud-config
autoinstall:
  version: 1
  updates: all
  locale: "en_US.UTF-8"
  interactive-sections:
    - identity
    - keyboard
  storage:
    layout:
      name: hybrid
      encrypted: yes
      sizing-policy: all
  packages:
    - ansible
    - clevis
    - clevis-luks
    - clevis-initramfs
    - curl
    - gnupg
    - software-properties-common
    - uuid-runtime
  drivers:
    install: true
  ssh:
    install-server: false
    authorized-keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIC4wGFQtP60UQDmmPzvCaLjEXG98iPBIkelnjVgGifkA
    allow-pw: false
  late-commands:
    - curtin in-target -- bash -c '
        apt-get purge -y gnome-initial-setup;
        ubuntu-report -f send no;
      '

    # 🛠️ System vollständig aktualisieren
    - curtin in-target -- bash -c '
        apt update && apt full-upgrade -y && apt autoremove -y
      '
    - curtin in-target -- bash -c '
        apt install -y unattended-upgrades;
        dpkg-reconfigure -f noninteractive unattended-upgrades;
      '

    # 🖥️ Hostname LIX+6‑Ziffern
    - curtin in-target -- bash -c '
        RAND=$(head /dev/urandom | tr -dc 0-9 | head -c 6);
        HOST="LIX$RAND";
        hostnamectl set-hostname "$HOST";
        echo "$HOST" > /etc/hostname;
        sed -i "s/127.0.1.1.*/127.0.1.1 $HOST/" /etc/hosts;
      '
    # 🌐 Microsoft Edge installieren
    - curtin in-target -- bash -c '
        curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /usr/share/keyrings/microsoft.gpg;
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge.list;
        apt update && apt install -y microsoft-edge-stable;
      '
    # 📥 Intune Portal installieren
    - curtin in-target -- bash -c '
        curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /usr/share/keyrings/microsoft-archive.gpg;
        sh -c "echo \"deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-archive.gpg] https://packages.microsoft.com/ubuntu/$(lsb_release -rs)/prod $(lsb_release -cs) main\" > /etc/apt/sources.list.d/microsoft-prod.list";
        apt update;
        apt install -y intune-portal;
      '
    # ▶️ Intune Portal Autostart beim Login – echten Benutzer per /home erkennen
    - curtin in-target -- bash -c "for dir in /home/*; do \
        [ -d \"\$dir\" ] || continue; \
        USER=\$(basename \"\$dir\"); \
        mkdir -p \"\$dir/.config/autostart\"; \
        echo \"[Desktop Entry]\" > \"\$dir/.config/autostart/intune-portal.desktop\"; \
        echo \"Type=Application\" >> \"\$dir/.config/autostart/intune-portal.desktop\"; \
        echo \"Exec=intune-portal\" >> \"\$dir/.config/autostart/intune-portal.desktop\"; \
        echo \"Hidden=false\" >> \"\$dir/.config/autostart/intune-portal.desktop\"; \
        echo \"NoDisplay=false\" >> \"\$dir/.config/autostart/intune-portal.desktop\"; \
        echo \"X-GNOME-Autostart-enabled=true\" >> \"\$dir/.config/autostart/intune-portal.desktop\"; \
        echo \"Name=Intune Portal\" >> \"\$dir/.config/autostart/intune-portal.desktop\"; \
        echo \"Comment=Startet Microsoft Intune Portal automatisch\" >> \"\$dir/.config/autostart/intune-portal.desktop\"; \
        chown -R \"\$USER:\$USER\" \"\$dir/.config\"; \
      done"